<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>DialogFlow + Cloud Functions + Firestore</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">DialogFlow + Cloud Functions + Firestore</h1>
</header>
<section data-field="subtitle" class="p-summary">
Um simples webhook para conectar à uma base de dados
</section>
<section data-field="body" class="e-content">
<section name="f548" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><figure name="ac50" id="ac50" class="graf graf--figure graf--leading"><img class="graf-image" data-image-id="1*_TBbgk94feXf2vS5BFDvLA.png" data-width="1043" data-height="313" src="https://cdn-images-1.medium.com/max/800/1*_TBbgk94feXf2vS5BFDvLA.png"></figure><h3 name="5e80" id="5e80" class="graf graf--h3 graf-after--figure graf--title">DialogFlow + Cloud Functions + Firestore</h3><h4 name="d650" id="d650" class="graf graf--h4 graf-after--h3 graf--subtitle">Um simples webhook para conectar à uma base de dados</h4><p name="b251" id="b251" class="graf graf--p graf-after--h4">Foi ontem que aconteceu o primeiro evento da série <a href="https://developers.google.com/events/buildactions/" data-href="https://developers.google.com/events/buildactions/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Build Actions for Your Community</a> em Maputo. Esta série de eventos visa ensinar a desenvolver aplicações utilizando o Google Assistant.</p><p name="fb9c" id="fb9c" class="graf graf--p graf-after--p">Todos que desenvolverem uma app para o Google Assistant, podem submeter essa app para ser avaliada. E se a app cumprir com <a href="https://developers.google.com/actions/community/faq#eligibility" data-href="https://developers.google.com/actions/community/faq#eligibility" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">alguns critérios</a>, os desenvolvedores tornam-se parte da <a href="https://developers.google.com/actions/community/" data-href="https://developers.google.com/actions/community/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Comunidade de Desenvolvedores do Google Assistant</a> onde têm a chance de ganhar vários prêmios.</p><p name="7fb2" id="7fb2" class="graf graf--p graf-after--p graf--trailing">Com o objetivo de ajudar todos que estiverem interessados em participar da comunidade, decidi escrever este artigo em que mostro como conectar o nosso agente do DialogFlow com uma base de dados (<a href="https://medium.com/android-dev-moz/firestore-8d225062ffe8" data-href="https://medium.com/android-dev-moz/firestore-8d225062ffe8" class="markup--anchor markup--p-anchor" target="_blank">Cloud Firestore for Firebase</a>).</p></div></div></section><section name="e392" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="2725" id="2725" class="graf graf--p graf--leading">Assumo que você já conheça o DialogFlow, sabe criar Intents e Entities para ter um diálogo simples com o utilizador. Caso não, veja como fazer isso <a href="https://medium.com/@rosariopfernandes/ml-b7eba66e0e03" data-href="https://medium.com/@rosariopfernandes/ml-b7eba66e0e03" class="markup--anchor markup--p-anchor" target="_blank">neste artigo</a>.</p><p name="901b" id="901b" class="graf graf--p graf-after--p">Bom, para este artigo vamos desenvolver uma app para reportar casos de contentores de lixo cheios. Este é um problema muito comum em Maputo e foi uma das sugestões durante o nosso Build Actions for Your Community.</p><p name="874c" id="874c" class="graf graf--p graf-after--p">Basicamente, os utilizadores irão utilizar a app para:</p><ol class="postList"><li name="af20" id="af20" class="graf graf--li graf-after--p">Reportar quando vêm um contentor de lixo cheio, indicando o bairro onde viram isso;</li><li name="7f6d" id="7f6d" class="graf graf--li graf-after--li">Verificar se o problema que eles reportaram já foram resolvidos;</li><li name="a5e5" id="a5e5" class="graf graf--li graf-after--li">Ver todos problemas reportados.</li></ol><h3 name="caf9" id="caf9" class="graf graf--h3 graf-after--li">Entities</h3><p name="d6c2" id="d6c2" class="graf graf--p graf-after--h3">Vamos começar então a criar as nossas Entities. A primeira Entity seria o nome de alguns bairros de Maputo:</p><figure name="aaad" id="aaad" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*hHDEpSaEfM7MhY6FhyRpqA.png" data-width="665" data-height="661" src="https://cdn-images-1.medium.com/max/800/1*hHDEpSaEfM7MhY6FhyRpqA.png"><figcaption class="imageCaption">Entity com bairros de Maputo</figcaption></figure><p name="c85b" id="c85b" class="graf graf--p graf-after--figure">Você pode encontrar a Entity Bairro <a href="https://github.com/rosariopfernandes/Lixo-Report/blob/master/entities/Bairro.json" data-href="https://github.com/rosariopfernandes/Lixo-Report/blob/master/entities/Bairro.json" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">aqui</a>.</p><h3 name="794e" id="794e" class="graf graf--h3 graf-after--p">Intents</h3><p name="947c" id="947c" class="graf graf--p graf-after--h3">Depois de ter a nossa Entity criada, podemos começar a criar os Intents.</p><h4 name="f51f" id="f51f" class="graf graf--h4 graf-after--p">Intent 1 — Reportar</h4><p name="ae57" id="ae57" class="graf graf--p graf-after--h4">Podemos começar com o Intent para reportar um contentor cheio:</p><figure name="6b8a" id="6b8a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*HJREOHkaungpD5gyplaqyg.png" data-width="725" data-height="614" src="https://cdn-images-1.medium.com/max/800/1*HJREOHkaungpD5gyplaqyg.png"><figcaption class="imageCaption">Training Phrases do Intent “Reportar”</figcaption></figure><h4 name="d5aa" id="d5aa" class="graf graf--h4 graf-after--figure">Intent 2 — Verificar Estado</h4><p name="7ab2" id="7ab2" class="graf graf--p graf-after--h4">De seguida podemos criar um Intent para verificar o estado do report:</p><figure name="20b7" id="20b7" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*WI65eSBtaoGL9afy9ziU0A.png" data-width="717" data-height="751" src="https://cdn-images-1.medium.com/max/800/1*WI65eSBtaoGL9afy9ziU0A.png"><figcaption class="imageCaption">Training Phrases do Intent “Verificar Estado”</figcaption></figure><h4 name="d8cd" id="d8cd" class="graf graf--h4 graf-after--figure">Intent 3 — Ver Reports</h4><p name="0484" id="0484" class="graf graf--p graf-after--h4">Criamos então o último Intent que vai procurar todos os reports já criados:</p><figure name="ce82" id="ce82" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*e3VzipWu3CCgAkYvi5FbSA.png" data-width="664" data-height="485" src="https://cdn-images-1.medium.com/max/800/1*e3VzipWu3CCgAkYvi5FbSA.png"><figcaption class="imageCaption">Training Phrases do Intent “Ver Reports”</figcaption></figure><p name="bedd" id="bedd" class="graf graf--p graf-after--figure">E para todos os 3 Intents, temos de ativar a opção Fullfilment (última opção da página de cada Intent):</p><figure name="628a" id="628a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*ofqe7_G06T9qOR9EO7PFvw.png" data-width="648" data-height="197" src="https://cdn-images-1.medium.com/max/800/1*ofqe7_G06T9qOR9EO7PFvw.png"></figure><p name="71af" id="71af" class="graf graf--p graf-after--figure">Você pode encontrar todos os Intents <a href="https://github.com/rosariopfernandes/Lixo-Report/tree/master/intents" data-href="https://github.com/rosariopfernandes/Lixo-Report/tree/master/intents" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">aqui</a>.</p><h3 name="d824" id="d824" class="graf graf--h3 graf-after--p">Fulfillment (Cloud Functions)</h3><p name="d266" id="d266" class="graf graf--p graf-after--h3">Agora que temos o Fulfillment ativo, podemos utilizar <a href="https://medium.com/@rosariopfernandes/firebase-cloud-functions-f6ed3787fa8d" data-href="https://medium.com/@rosariopfernandes/firebase-cloud-functions-f6ed3787fa8d" class="markup--anchor markup--p-anchor" target="_blank">Cloud Functions</a> para conectar o nosso agente do DialogFlow ao <a href="https://medium.com/android-dev-moz/firestore-8d225062ffe8" data-href="https://medium.com/android-dev-moz/firestore-8d225062ffe8" class="markup--anchor markup--p-anchor" target="_blank">Cloud Firestore</a> (a nossa base de dados).</p><p name="468c" id="468c" class="graf graf--p graf-after--p">Para isso, clicamos na opção “Fulfillment” que fica na aba à esquerda e ativamos a opção “Inline Editor”:</p><figure name="c89a" id="c89a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*YB_Hv6Z7_Qw76rS_1nbMAA.png" data-width="665" data-height="359" src="https://cdn-images-1.medium.com/max/800/1*YB_Hv6Z7_Qw76rS_1nbMAA.png"></figure><p name="0ebd" id="0ebd" class="graf graf--p graf-after--figure">Isso dá-nos um editor onde podemos editar 2 ficheiros: <code class="markup--code markup--p-code">index.js</code> e <code class="markup--code markup--p-code">package.json</code>. Estes 2 ficheiros fazem parte do serviço Cloud Functions for Firebase.</p><p name="40f8" id="40f8" class="graf graf--p graf-after--p">Começamos por editar o ficheiro <code class="markup--code markup--p-code">package.json</code>. Isso porque, por defeito, ele vem configurado com versões antigas do Cloud Functions(0.5.7) e do Firebase Admin SDK(4.2.1). Então temos de atualizar essas dependências:</p><figure name="68e7" id="68e7" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/rosariopfernandes/65dfa9d90f0466662d55729fbf8ec7e1.js"></script></figure><p name="dd7e" id="dd7e" class="graf graf--p graf-after--figure">E aqui deixo o código do <code class="markup--code markup--p-code">index.js</code> com comentários que explicam as linhas de código:</p><figure name="7e2b" id="7e2b" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/rosariopfernandes/cf9b0da789e7ed893e951cc3a2a63534.js"></script></figure><p name="438c" id="438c" class="graf graf--p graf-after--figure">Espero que esteja fácil de perceber.</p><p name="3f74" id="3f74" class="graf graf--p graf-after--p">Mas antes de testarmos a nossa aplicação, fica uma dúvida: Onde vão parar esses dados?</p><h3 name="314d" id="314d" class="graf graf--h3 graf-after--p">Cloud Firestore for Firebase</h3><p name="692f" id="692f" class="graf graf--p graf-after--h3">O código que deixei acima serve para escrever e ler dados do Firestore que é um dos serviços de armazenamento do Firebase. Podemos aceder esses dados na <a href="https://console.firebase.google.com" data-href="https://console.firebase.google.com" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Consola do Firebase</a>.</p><p name="1546" id="1546" class="graf graf--p graf-after--p">Ao acedermos à consola, é mostrada uma lista de projetos que temos no Firebase. Escolha o projeto que tem o mesmo nome que o agente que criou no DialogFlow.<br>Será exibida uma página de Visão Geral do projeto. Na aba esquerda, clique na opção “Database” e você verá 2 opções: “Realtime Database” e “Firestore”.</p><p name="e5d6" id="e5d6" class="graf graf--p graf-after--p">Escolha Firestore e inicie em modo de teste (base de dados pública).</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="e24f" id="e24f" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><img class="graf-image" data-image-id="1*epIPhd4lumCRiOKz-bE9Ww.png" data-width="1297" data-height="521" src="https://cdn-images-1.medium.com/max/1200/1*epIPhd4lumCRiOKz-bE9Ww.png"></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="3f81" id="3f81" class="graf graf--p graf-after--figure">Quando o Cloud Firestore for ativado, você pode então testar a aplicação.</p><h3 name="1603" id="1603" class="graf graf--h3 graf-after--p">Considerações Finais</h3><ul class="postList"><li name="3671" id="3671" class="graf graf--li graf-after--h3">O código do fulfillment utiliza a função <code class="markup--code markup--li-code">close()</code> que termina a conversa com a nossa app. Se você quiser continuar a executar a app, substitua-o pela função <code class="markup--code markup--li-code">ask()</code>;</li><li name="f9d7" id="f9d7" class="graf graf--li graf-after--li graf--trailing">O modo de teste do Firestore não é seguro pois ele deixa a base de dados pública, o que significa que qualquer pessoa poderá ler e escrever dados lá. Veja <a href="https://firebase.google.com/docs/firestore/security/get-started?hl=pt-br" data-href="https://firebase.google.com/docs/firestore/security/get-started?hl=pt-br" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">aqui</a> como manter os seus dados seguros.</li></ul></div></div></section><section name="b82a" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="365c" id="365c" class="graf graf--p graf--leading graf--trailing">Se você tem alguma dúvida ou sugestão, não hesite em me contactar pelo email <a href="mailto:rosariofernandes51@gmail.com" data-href="mailto:rosariofernandes51@gmail.com" class="markup--anchor markup--p-anchor" target="_blank">rosariofernandes51@gmail.com</a> ou pelo <a href="https://telegram.me/rosariopfernandes" data-href="https://telegram.me/rosariopfernandes" class="markup--anchor markup--p-anchor" rel="nofollow noopener nofollow noopener noopener" target="_blank">Telegram</a>. Ficarei feliz por conversar com você. :)</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@thatfire.dev" class="p-author h-card">Rosário Pereira Fernandes</a> on <a href="https://medium.com/p/d620740f3588"><time class="dt-published" datetime="2018-06-10T16:56:59.205Z">June 10, 2018</time></a>.</p><p><a href="https://medium.com/@thatfire.dev/webhook-d620740f3588" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on November 24, 2025.</p></footer></article></body></html>