<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Como funcionam as regras de seguranÃ§a do Firebase na Realtime Database?</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Como funcionam as regras de seguranÃ§a do Firebase na Realtime Database?</h1>
</header>
<section data-field="subtitle" class="p-summary">
Parte 4â€Šâ€”â€ŠTestes UnitÃ¡rios
</section>
<section data-field="body" class="e-content">
<section name="32ab" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><figure name="9e03" id="9e03" class="graf graf--figure graf--leading"><img class="graf-image" data-image-id="1*FiOk3gqNFoavQW8n4vO7Fw.png" data-width="800" data-height="240" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*FiOk3gqNFoavQW8n4vO7Fw.png"></figure><h3 name="3c49" id="3c49" class="graf graf--h3 graf-after--figure graf--title">Como funcionam as regras de seguranÃ§a do Firebase na Realtime Database?</h3><h4 name="0310" id="0310" class="graf graf--h4 graf-after--h3 graf--subtitle">Parte 4â€Šâ€”â€ŠTestes UnitÃ¡rios</h4><p name="3acc" id="3acc" class="graf graf--p graf-after--h4">Na <a href="https://medium.com/@rosariopfernandes/fbs3-531abda78169" data-href="https://medium.com/@rosariopfernandes/fbs3-531abda78169" class="markup--anchor markup--p-anchor" target="_blank">parte 3</a> desta sÃ©rie de artigos mostrei como utilizar o Simulador de Regras da Realtime Database. O simulador Ã© uma ferramenta muito Ãºtil e que ajuda bastante na hora de testar as nossas regras online.</p><p name="e649" id="e649" class="graf graf--p graf-after--p">Mas hoje, durante o <a href="http://firebase.google.com/summit" data-href="http://firebase.google.com/summit" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Firebase Summit 2018</a>, foram lanÃ§adas 2 novas ferramentas que ajudam tambÃ©m na hora de testar regras: o<strong class="markup--strong markup--p-strong"> </strong><a href="https://firebase.google.com/docs/database/security/test-rules-emulator" data-href="https://firebase.google.com/docs/database/security/test-rules-emulator" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">Emulador da Realtime Database</strong></a> e o mÃ³dulo <strong class="markup--strong markup--p-strong">firebase-testing</strong> da Firebase CLI. Neste artigo mostro como funcionam estas ferramentas e como elas facilitam-nos quando queremos verificar o comportamento das nossas regras de seguranÃ§a.</p><h3 name="bf4f" id="bf4f" class="graf graf--h3 graf-after--p">Realtime DatabaseÂ Emulator</h3><p name="0786" id="0786" class="graf graf--p graf-after--h3">O emulador da Realtime Database Ã© uma ferramenta que permite simular uma instÃ¢ncia de uma database na nossa mÃ¡quina local. Todas as operaÃ§Ãµes que executamos na nossa Realtime Database podem ser simuladas localmente no emulador. A Ãºnica diferenÃ§a Ã© que o emulador nÃ£o estÃ¡ interligado aos outros serviÃ§os do Firebase.</p><h4 name="1c8c" id="1c8c" class="graf graf--h4 graf-after--p">InstalaÃ§Ã£o</h4><p name="d948" id="d948" class="graf graf--p graf-after--h4">Para instalar o emulador, temos de executar os seguintes comandos:</p><pre name="eacb" id="eacb" class="graf graf--pre graf-after--p">firebase --open-sesame emulators<br>firebase setup:emulators:database</pre><h4 name="edb2" id="edb2" class="graf graf--h4 graf-after--pre">Iniciar</h4><p name="26f7" id="26f7" class="graf graf--p graf-after--h4">Agora que temos o emulador instalado, podemos iniciÃ¡-lo usando o comando: <code class="markup--code markup--p-code">firebase serve --only firestore</code>. Ao introduzir o comando, deverÃ¡ aparecer uma mensagem dizendo â€œListening on port 9000â€ no seu ecrÃ£.</p><p name="5ce3" id="5ce3" class="graf graf--p graf-after--p">Geralmente a Realtime Database pode ser acedida atravÃ©s da URL <code class="markup--code markup--p-code">https://&lt;nome-da-database&gt;.firebaseio.com/caminho/dos/dados.json</code>. Ao iniciar o emulador, a mesma database pode ser acedida tambÃ©m pela URL <code class="markup--code markup--p-code">http://localhost:9000/caminho/dos/dados.json?ns=&lt;nome-da-database&gt;</code>.</p><p name="6c83" id="6c83" class="graf graf--p graf-after--p">Quando vocÃª inicia o emulador, a realtime database simulada Ã© criada com as regras privadas (<code class="markup--code markup--p-code">.write</code> eÂ <code class="markup--code markup--p-code">.read</code> em <code class="markup--code markup--p-code">false</code>).</p><h3 name="17dd" id="17dd" class="graf graf--h3 graf-after--p">MÃ³dulo node.js firebase-testing</h3><p name="8e6e" id="8e6e" class="graf graf--p graf-after--h3">Este mÃ³dulo permite-nos escrever testes unitÃ¡rios para a nossa database. Neste artigo, vamos criar um diretÃ³rio chamado <code class="markup--code markup--p-code">teste</code>, e neste diretÃ³rio vamos instalar o nosso mÃ³dulo <code class="markup--code markup--p-code">firebase-testing</code>. Para isso, basta utilizarmos o comando:</p><pre name="1b3b" id="1b3b" class="graf graf--pre graf-after--p">npm install --save @firebase/testing</pre><h4 name="04bc" id="04bc" class="graf graf--h4 graf-after--pre">async/await</h4><p name="dde6" id="dde6" class="graf graf--p graf-after--h4">Antes de comeÃ§armos a escrever os testes unitÃ¡rios, hÃ¡ 2 conceitos que podem ser novos para vocÃª: <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">async</strong></code> e <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">await</strong></code>.</p><p name="1db2" id="1db2" class="graf graf--p graf-after--p">VocÃª jÃ¡ deve saber que as funÃ§Ãµes de leitura e escrita do Firebase <a href="https://pt.stackoverflow.com/a/278696/39181" data-href="https://pt.stackoverflow.com/a/278696/39181" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">funcionam de forma assÃ­ncrona</a>. Mas como os nossos testes serÃ£o executados em sequÃªncia, nÃ£o podemos fazÃª-los de forma assÃ­ncrona, pois a sequÃªncia se perderÃ¡.</p><p name="6e1f" id="6e1f" class="graf graf--p graf-after--p">E para nos ajudar com isso, o JavaScript possui o <code class="markup--code markup--p-code">async</code> e o <code class="markup--code markup--p-code">await</code> que permitem-nos esperar pelo resultado de uma operaÃ§Ã£o antes de ir para a prÃ³xima. Por exemplo, para ler um utilizador de forma assÃ­ncrona no JavaScript, vocÃª faria:</p><pre name="30b2" id="30b2" class="graf graf--pre graf-after--p">function lerUtilizador(uid)<br>{<br>  rootRef.child(&quot;utilizadores&quot;).child(uid).once(&#39;value&#39;, function(snapshot){<br>      var utilizador = snapshot.val();<br>      //Mostrar o utilizador<br>  });<br>}</pre><p name="33b4" id="33b4" class="graf graf--p graf-after--pre">Para fazer a mesma leitura, de forma sÃ­ncrona, vocÃª deve fazer:</p><pre name="b7bf" id="b7bf" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">async</strong> function lerUtilizador(uid)<br>{<br>  var snapshot = <strong class="markup--strong markup--pre-strong">await</strong> rootRef.child(&quot;utilizadores&quot;).child(uid).once(&#39;value&#39;);<br>  var utilizador = snapshot.val();<br>  //Mostrar o utilizador<br>}</pre><p name="999e" id="999e" class="graf graf--p graf-after--pre">HÃ¡ uma coisa a notar: o <code class="markup--code markup--p-code">async</code> serve para anotar funÃ§Ãµes e o <code class="markup--code markup--p-code">await</code> sÃ³ pode ser utilizado em funÃ§Ãµes que foram declaradas com a anotaÃ§Ã£o <code class="markup--code markup--p-code">async</code>.</p><p name="9aab" id="9aab" class="graf graf--p graf-after--p">VocÃª pode aprender mais sobre async e await <a href="https://medium.com/@pedrodava/javascript-101-async-await-50a0428a0929" data-href="https://medium.com/@pedrodava/javascript-101-async-await-50a0428a0929" class="markup--anchor markup--p-anchor" target="_blank">neste post</a> do <a href="https://medium.com/u/58a6ee125066" data-href="https://medium.com/u/58a6ee125066" data-anchor-type="2" data-user-id="58a6ee125066" data-action-value="58a6ee125066" data-action="show-user-card" data-action-type="hover" class="markup--user markup--p-user" target="_blank">Jose Pedro Dava</a>.</p><h4 name="a2ff" id="a2ff" class="graf graf--h4 graf-after--p">Escrever Testes UnitÃ¡rios</h4><p name="2c5e" id="2c5e" class="graf graf--p graf-after--h4">Para escrever os nossos testes, o firebase-testing possui as funÃ§Ãµes:</p><ul class="postList"><li name="5142" id="5142" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code u-paddingRight0 u-marginRight0"><strong class="markup--strong markup--li-strong">initializeTestApp</strong>({ databaseName, auth })</code>â€Šâ€”â€Šsimula uma app que estÃ¡ a ser acedida por um utilizador autenticado, que Ã© especificado no parÃ¢metro <code class="markup--code markup--li-code">auth</code>.</li><li name="ef4c" id="ef4c" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code u-paddingRight0 u-marginRight0"><strong class="markup--strong markup--li-strong">initializeAdminApp</strong>({ databaseName })</code>â€Šâ€”â€Šsimula uma app que estÃ¡ ser acedida com privilÃ©gios de administrador (Ã© como usar o Admin SDK ou a REST API para aceder Ã  database).</li><li name="2b9a" id="2b9a" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code u-paddingRight0 u-marginRight0"><strong class="markup--strong markup--li-strong">loadRules</strong>({ databaseNameÂ , rulesPath })</code>â€Šâ€”â€Šcarrega as regras de seguranÃ§a que iremos testar.</li><li name="705e" id="705e" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code u-paddingRight0 u-marginRight0"><strong class="markup--strong markup--li-strong">apps</strong>()</code>â€Šâ€”â€Šretorna a lista de todos as apps que foram inicializadas para simulaÃ§Ã£o.</li><li name="8ec6" id="8ec6" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code u-paddingRight0 u-marginRight0"><strong class="markup--strong markup--li-strong">assertFails</strong>(pr: Promise)</code>â€Šâ€”â€Šverifica se uma escrita/leitura irÃ¡ falhar.</li><li name="3089" id="3089" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code u-paddingRight0 u-marginRight0"><strong class="markup--strong markup--li-strong">assertSucceeds</strong>(pr: Promise)</code>â€Šâ€”â€Šverifica se uma escrita/leitura irÃ¡ ser executada com sucesso.</li></ul><p name="addd" id="addd" class="graf graf--p graf-after--li">Agora que conhecemos as funÃ§Ãµes, podemos entÃ£o escrever testes unitÃ¡rios para as regras (veja <a href="https://gist.github.com/rosariopfernandes/1ec0d39cd0322a4b13edb6a5ace1decb" data-href="https://gist.github.com/rosariopfernandes/1ec0d39cd0322a4b13edb6a5ace1decb" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">database.rules.json</a>) da database que temos usado durante esta sÃ©rie de artigos (veja <a href="https://gist.github.com/rosariopfernandes/d9af6a5c5aca7caf0c5471bfef8771ea#file-mydatabase-json" data-href="https://gist.github.com/rosariopfernandes/d9af6a5c5aca7caf0c5471bfef8771ea#file-mydatabase-json" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">MyDatabase.json</a>).</p><p name="7780" id="7780" class="graf graf--p graf-after--p">Por exemplo, uma regra que definimos foi: <em class="markup--em markup--p-em">â€œUtilizadores sÃ³ podem enviar mensagens para grupos que fazem parteâ€</em>. A regra escrita foi:</p><figure name="a5d0" id="a5d0" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/rosariopfernandes/007776334330d54aac88742b732a665a.js"></script></figure><p name="574f" id="574f" class="graf graf--p graf-after--figure">E o cÃ³digo JavaScript para enviar a mensagem seria algo como:</p><pre name="13b3" id="13b3" class="graf graf--pre graf-after--p">rootRef.child(â€œmensagens/g1â€).push().set(â€œOlÃ¡ Mundo!â€);</pre><p name="c758" id="c758" class="graf graf--p graf-after--pre">EntÃ£o usamos este mesmo cÃ³digo simulando um utilizador autenticado. Podemos verificar se o utilizador de <code class="markup--code markup--p-code">uid=â€uid1&quot;</code> pode realmente escrever no grupo com a chave â€œg1â€ (que ele faz parte):</p><pre name="f86a" id="f86a" class="graf graf--pre graf-after--p">let firebase = require(&quot;<a href="http://twitter.com/firebase/testing" data-href="http://twitter.com/firebase/testing" class="markup--anchor markup--pre-anchor" title="Twitter profile for @firebase/testing" rel="noopener" target="_blank">@firebase/testing</a>&quot;);</pre><pre name="85f2" id="85f2" class="graf graf--pre graf-after--pre">let app = firebase.initializeTestApp({ databaseName: &quot;MinhaDB&quot;, auth: {uid:&quot;uid1&quot;} });</pre><pre name="9d39" id="9d39" class="graf graf--pre graf-after--pre">await firebase.assertSucceeds(app.database().ref(&quot;mensagens/g1&quot;).push().set(&quot;OlÃ¡ Mundo&quot;));</pre><p name="ec4d" id="ec4d" class="graf graf--p graf-after--pre">E podemos nos certificar que ele nÃ£o tem acesso ao grupo â€œg2â€:</p><pre name="1092" id="1092" class="graf graf--pre graf-after--p">await firebase.assertFails(app.database().ref(&quot;mensagens/g2&quot;).push().set(&quot;OlÃ¡ Mundo&quot;));</pre><p name="e102" id="e102" class="graf graf--p graf-after--pre">Juntando os dois, o nosso ficheiro <code class="markup--code markup--p-code">index.js</code>(no directÃ³rio <code class="markup--code markup--p-code">teste</code>) ficaria assim:</p><figure name="0c4d" id="0c4d" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/rosariopfernandes/6cddf60f2a49ced35d4f02ad49808851.js"></script></figure><p name="cf8e" id="cf8e" class="graf graf--p graf-after--figure">Este Ã© um dos exemplos mais simples. Completei o ficheiro <code class="markup--code markup--p-code">index.js</code> para testar todas as regras que foram definidas, e ficou assim:</p><figure name="cf94" id="cf94" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/rosariopfernandes/e96540e3b894e055e67023b30ac2363b.js"></script></figure><p name="a7d0" id="a7d0" class="graf graf--p graf-after--figure">Depois de escrever os testes, temos de executÃ¡-los. Para isso, voltamos Ã  terminal e (no diretÃ³rio parente do diretÃ³rio teste) executamos o comando <code class="markup--code markup--p-code">npm test teste</code>. VocÃª deverÃ¡ ter um output semelhante Ã  este:</p><figure name="2625" id="2625" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*AH1yajM6wSHkRjZqieahLw.png" data-width="814" data-height="548" src="https://cdn-images-1.medium.com/max/800/1*AH1yajM6wSHkRjZqieahLw.png"></figure><p name="5acd" id="5acd" class="graf graf--p graf-after--figure graf--trailing">E por hoje Ã© tudo. Espero que vocÃª tenha compreendido e que comece tambÃ©m a escrever testes unitÃ¡rios para a sua database.Â ;)</p></div></div></section><section name="57fa" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="817f" id="817f" class="graf graf--p graf--leading graf--trailing">Caso tenha alguma dÃºvida ou sugestÃ£o, deixe abaixo nos comentÃ¡rios. Se vocÃª estiver tentando escrever testes unitÃ¡rios e teve um problema, <a href="https://pt.stackoverflow.com/questions/ask?tags=firebase" data-href="https://pt.stackoverflow.com/questions/ask?tags=firebase" class="markup--anchor markup--p-anchor" rel="noopener nofollow noopener" target="_blank">coloque ele no StackOverflow</a>, mostrando o que vocÃª fez e qual foi o erro que teve. De certeza que vocÃª obterÃ¡ ajuda de mim ou de alguÃ©m da comunidade. ğŸ™‚</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@thatfire.dev" class="p-author h-card">RosÃ¡rio Pereira Fernandes</a> on <a href="https://medium.com/p/8c45c9457c9"><time class="dt-published" datetime="2018-10-29T16:56:01.227Z">October 29, 2018</time></a>.</p><p><a href="https://medium.com/@thatfire.dev/fbs4-8c45c9457c9" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on November 24, 2025.</p></footer></article></body></html>